<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZIP Delivery Locator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="ZIP Code Delivery Location Finder with physical address information and dark/light mode toggle." />
  <style>
    .fade-in { animation: fade 0.5s ease-in-out; }
    @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
    body { transition: background-color 0.3s, color 0.3s; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">
  <main class="w-full max-w-xl">
    <header class="text-center mb-6 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold tracking-tight text-indigo-400">ZIP Delivery Locator</h1>
        <p class="text-sm text-gray-400">Physical address lookup ‚Ä¢ Geo-targeted redirects</p>
      </div>
      <button id="themeToggle" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full px-3 py-1 text-sm transition">‚òÄÔ∏è</button>
    </header>

    <section id="card" class="bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
      <div id="image-wrap" class="w-full h-48 bg-gradient-to-br from-indigo-700 to-indigo-500 flex items-center justify-center">
        <div id="image-fallback" class="text-white/90 text-lg font-medium">Loading image‚Ä¶</div>
      </div>
      <div class="p-6 space-y-2">
        <div id="result" class="text-lg">Loading‚Ä¶</div>
        <div id="meta" class="text-xs text-gray-400"></div>
      </div>
    </section>

    <footer class="text-center mt-6 text-xs text-gray-500">
      Tip: try <span class="font-mono">?zip=90210</span>
    </footer>
  </main>

  <script>
    // ------- Theme helper -------
    const toggleBtn = document.getElementById('themeToggle');

    function applyTheme(isDark) {
      const body = document.body;
      const card = document.getElementById('card');
      const header = document.querySelector('header');

      if (isDark) {
        body.style.backgroundColor = '#111827';
        body.style.color = '#f9fafb';
        card.classList.remove('bg-white', 'text-gray-800');
        card.classList.add('bg-gray-800', 'text-gray-100');
        header.querySelector('h1').classList.add('text-indigo-400');
        toggleBtn.textContent = '‚òÄÔ∏è';
      } else {
        body.style.backgroundColor = '#f9fafb';
        body.style.color = '#1f2937';
        card.classList.remove('bg-gray-800', 'text-gray-100');
        card.classList.add('bg-white', 'text-gray-800');
        header.querySelector('h1').classList.remove('text-indigo-400');
        header.querySelector('h1').classList.add('text-indigo-600');
        toggleBtn.textContent = 'üåô';
      }

      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function initTheme() {
      const saved = localStorage.getItem('theme');
      applyTheme(!saved || saved === 'dark'); // Default dark
    }

    toggleBtn.addEventListener('click', () => {
      const isDark = localStorage.getItem('theme') !== 'dark';
      applyTheme(isDark);
    });

    initTheme();

    // ------- Utility helpers -------
    const slugify = (s) => s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

    // State abbreviation to full name mapping
    const stateMap = {
      'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
      'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
      'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
      'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
      'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
      'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
      'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
      'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
      'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
      'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
      'DC': 'District of Columbia', 'PR': 'Puerto Rico', 'VI': 'Virgin Islands', 'GU': 'Guam',
      'AS': 'American Samoa', 'MP': 'Northern Mariana Islands'
    };

    function getZipParam() {
      const params = new URLSearchParams(window.location.search);
      return params.get('zip');
    }

    function getStateParam() {
      const params = new URLSearchParams(window.location.search);
      return params.get('state');
    }

    // State information database
    const stateInfo = {
      'TX': { name: 'Texas', capital: 'Austin', nickname: 'Lone Star State', population: '30,503,301', area: '268,596 sq mi', zipPrefix: '7' },
      'CA': { name: 'California', capital: 'Sacramento', nickname: 'Golden State', population: '39,128,162', area: '163,696 sq mi', zipPrefix: '9' },
      'NY': { name: 'New York', capital: 'Albany', nickname: 'Empire State', population: '19,677,151', area: '54,555 sq mi', zipPrefix: '1' },
      'FL': { name: 'Florida', capital: 'Tallahassee', nickname: 'Sunshine State', population: '22,610,726', area: '65,758 sq mi', zipPrefix: '3' },
      'IL': { name: 'Illinois', capital: 'Springfield', nickname: 'Prairie State', population: '12,582,032', area: '57,914 sq mi', zipPrefix: '6' },
      'PA': { name: 'Pennsylvania', capital: 'Harrisburg', nickname: 'Keystone State', population: '12,972,008', area: '46,054 sq mi', zipPrefix: '1' },
      'OH': { name: 'Ohio', capital: 'Columbus', nickname: 'Buckeye State', population: '11,785,935', area: '44,826 sq mi', zipPrefix: '4' },
      'GA': { name: 'Georgia', capital: 'Atlanta', nickname: 'Peach State', population: '11,029,227', area: '59,425 sq mi', zipPrefix: '3' },
      'NC': { name: 'North Carolina', capital: 'Raleigh', nickname: 'Tar Heel State', population: '10,835,491', area: '53,819 sq mi', zipPrefix: '2' },
      'MI': { name: 'Michigan', capital: 'Lansing', nickname: 'Great Lakes State', population: '10,034,113', area: '96,714 sq mi', zipPrefix: '4' },
      'NJ': { name: 'New Jersey', capital: 'Trenton', nickname: 'Garden State', population: '9,290,841', area: '8,723 sq mi', zipPrefix: '0' },
      'VA': { name: 'Virginia', capital: 'Richmond', nickname: 'Old Dominion', population: '8,683,619', area: '42,775 sq mi', zipPrefix: '2' },
      'WA': { name: 'Washington', capital: 'Olympia', nickname: 'Evergreen State', population: '7,812,880', area: '71,298 sq mi', zipPrefix: '9' },
      'AZ': { name: 'Arizona', capital: 'Phoenix', nickname: 'Grand Canyon State', population: '7,431,344', area: '113,990 sq mi', zipPrefix: '8' },
      'MA': { name: 'Massachusetts', capital: 'Boston', nickname: 'Bay State', population: '7,001,399', area: '10,554 sq mi', zipPrefix: '0' },
      'TN': { name: 'Tennessee', capital: 'Nashville', nickname: 'Volunteer State', population: '7,126,489', area: '42,144 sq mi', zipPrefix: '3' },
      'IN': { name: 'Indiana', capital: 'Indianapolis', nickname: 'Hoosier State', population: '6,862,199', area: '36,420 sq mi', zipPrefix: '4' },
      'MO': { name: 'Missouri', capital: 'Jefferson City', nickname: 'Show Me State', population: '6,177,957', area: '69,707 sq mi', zipPrefix: '6' },
      'MD': { name: 'Maryland', capital: 'Annapolis', nickname: 'Old Line State', population: '6,177,224', area: '12,406 sq mi', zipPrefix: '2' },
      'WI': { name: 'Wisconsin', capital: 'Madison', nickname: 'Badger State', population: '5,906,742', area: '65,496 sq mi', zipPrefix: '5' },
      'CO': { name: 'Colorado', capital: 'Denver', nickname: 'Centennial State', population: '5,877,610', area: '104,094 sq mi', zipPrefix: '8' },
      'MN': { name: 'Minnesota', capital: 'Saint Paul', nickname: 'North Star State', population: '5,737,915', area: '86,936 sq mi', zipPrefix: '5' },
      'SC': { name: 'South Carolina', capital: 'Columbia', nickname: 'Palmetto State', population: '5,373,555', area: '32,020 sq mi', zipPrefix: '2' },
      'AL': { name: 'Alabama', capital: 'Montgomery', nickname: 'Yellowhammer State', population: '5,108,468', area: '52,420 sq mi', zipPrefix: '3' },
      'LA': { name: 'Louisiana', capital: 'Baton Rouge', nickname: 'Pelican State', population: '4,573,749', area: '52,378 sq mi', zipPrefix: '7' },
      'KY': { name: 'Kentucky', capital: 'Frankfort', nickname: 'Bluegrass State', population: '4,526,154', area: '40,408 sq mi', zipPrefix: '4' },
      'OR': { name: 'Oregon', capital: 'Salem', nickname: 'Beaver State', population: '4,240,137', area: '98,379 sq mi', zipPrefix: '9' },
      'OK': { name: 'Oklahoma', capital: 'Oklahoma City', nickname: 'Sooner State', population: '4,053,824', area: '69,899 sq mi', zipPrefix: '7' },
      'CT': { name: 'Connecticut', capital: 'Hartford', nickname: 'Constitution State', population: '3,626,205', area: '5,543 sq mi', zipPrefix: '0' },
      'UT': { name: 'Utah', capital: 'Salt Lake City', nickname: 'Beehive State', population: '3,417,734', area: '84,897 sq mi', zipPrefix: '8' },
      'IA': { name: 'Iowa', capital: 'Des Moines', nickname: 'Hawkeye State', population: '3,207,004', area: '56,273 sq mi', zipPrefix: '5' },
      'NV': { name: 'Nevada', capital: 'Carson City', nickname: 'Silver State', population: '3,194,176', area: '110,572 sq mi', zipPrefix: '8' },
      'AR': { name: 'Arkansas', capital: 'Little Rock', nickname: 'Natural State', population: '3,067,732', area: '53,179 sq mi', zipPrefix: '7' },
      'MS': { name: 'Mississippi', capital: 'Jackson', nickname: 'Magnolia State', population: '2,939,690', area: '48,432 sq mi', zipPrefix: '3' },
      'KS': { name: 'Kansas', capital: 'Topeka', nickname: 'Sunflower State', population: '2,937,880', area: '82,278 sq mi', zipPrefix: '6' },
      'NM': { name: 'New Mexico', capital: 'Santa Fe', nickname: 'Land of Enchantment', population: '2,115,877', area: '121,590 sq mi', zipPrefix: '8' },
      'NE': { name: 'Nebraska', capital: 'Lincoln', nickname: 'Cornhusker State', population: '1,978,379', area: '77,348 sq mi', zipPrefix: '6' },
      'ID': { name: 'Idaho', capital: 'Boise', nickname: 'Gem State', population: '1,964,726', area: '83,569 sq mi', zipPrefix: '8' },
      'WV': { name: 'West Virginia', capital: 'Charleston', nickname: 'Mountain State', population: '1,770,071', area: '24,230 sq mi', zipPrefix: '2' },
      'HI': { name: 'Hawaii', capital: 'Honolulu', nickname: 'Aloha State', population: '1,455,271', area: '10,932 sq mi', zipPrefix: '9' },
      'NH': { name: 'New Hampshire', capital: 'Concord', nickname: 'Granite State', population: '1,395,231', area: '9,349 sq mi', zipPrefix: '0' },
      'ME': { name: 'Maine', capital: 'Augusta', nickname: 'Pine Tree State', population: '1,385,340', area: '35,380 sq mi', zipPrefix: '0' },
      'RI': { name: 'Rhode Island', capital: 'Providence', nickname: 'Ocean State', population: '1,098,163', area: '1,545 sq mi', zipPrefix: '0' },
      'MT': { name: 'Montana', capital: 'Helena', nickname: 'Treasure State', population: '1,122,867', area: '147,040 sq mi', zipPrefix: '5' },
      'DE': { name: 'Delaware', capital: 'Dover', nickname: 'First State', population: '1,018,396', area: '2,489 sq mi', zipPrefix: '1' },
      'SD': { name: 'South Dakota', capital: 'Pierre', nickname: 'Mount Rushmore State', population: '909,824', area: '77,116 sq mi', zipPrefix: '5' },
      'ND': { name: 'North Dakota', capital: 'Bismarck', nickname: 'Peace Garden State', population: '779,094', area: '70,698 sq mi', zipPrefix: '5' },
      'AK': { name: 'Alaska', capital: 'Juneau', nickname: 'Last Frontier', population: '733,391', area: '665,384 sq mi', zipPrefix: '9' },
      'VT': { name: 'Vermont', capital: 'Montpelier', nickname: 'Green Mountain State', population: '647,064', area: '9,616 sq mi', zipPrefix: '0' },
      'WY': { name: 'Wyoming', capital: 'Cheyenne', nickname: 'Equality State', population: '581,381', area: '97,813 sq mi', zipPrefix: '8' },
      'DC': { name: 'District of Columbia', capital: 'Washington', nickname: 'Nation\'s Capital', population: '678,972', area: '68 sq mi', zipPrefix: '2' }
    };

    async function fetchCSV(path) {
      const res = await fetch(path + '?v=' + Date.now());
      if (!res.ok) throw new Error('CSV fetch failed');
      const text = await res.text();
      const rows = text.trim().split('\n');
      const header = rows.shift().split(',').map(h => h.trim());
      return rows.map(line => {
        // Simple CSV parsing (handles quoted fields with commas)
        const cols = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cols.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        cols.push(current.trim());

        const obj = {};
        header.forEach((h, i) => obj[h] = (cols[i] || '').replace(/^"|"$/g, '').trim());
        return obj;
      });
    }

    function loadImage(url, timeoutMs = 5000) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const timer = setTimeout(() => { img.src = ''; reject(new Error('timeout')); }, timeoutMs);
        img.onload = () => { clearTimeout(timer); resolve(url); };
        img.onerror = () => { clearTimeout(timer); reject(new Error('error')); };
        img.referrerPolicy = 'no-referrer';
        img.src = url;
      });
    }

    async function tryLocal(city, stateAbbr) {
      const url = `images/${stateAbbr}/${slugify(city)}.jpg`;
      return loadImage(url);
    }

    async function tryWikimedia(city, state) {
      const title = encodeURIComponent(`${city}, ${state}`);
      const api = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original&titles=${title}&origin=*`;
      const r = await fetch(api);
      if (!r.ok) throw new Error('wikimedia fetch failed');
      const j = await r.json();
      const pages = j?.query?.pages || {};
      const first = Object.values(pages)[0];
      const url = first?.original?.source;
      if (!url) throw new Error('no wikimedia image');
      return loadImage(url);
    }

    async function tryPicsum(city, state) {
      const url = `https://picsum.photos/seed/${encodeURIComponent(slugify(city + '-' + state))}/800/400`;
      return loadImage(url);
    }

    function inlineSVG(city, stateAbbr) {
      const label = `${city}, ${stateAbbr}`;
      const svg = encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='800' height='400'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop offset='0%' stop-color='#6366f1'/>
              <stop offset='100%' stop-color='#a855f7'/>
            </linearGradient>
          </defs>
          <rect width='100%' height='100%' fill='url(#g)'/>
          <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui, sans-serif' font-size='36' fill='white' opacity='0.9'>${label}</text>
        </svg>`);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    async function resolveImage(city, state, stateAbbr) {
      const sources = [() => tryLocal(city, stateAbbr), () => tryWikimedia(city, state), () => tryPicsum(city, state)];
      for (const s of sources) {
        try { return await s(); } catch (e) {}
      }
      return inlineSVG(city, stateAbbr);
    }

    async function main() {
      const resultDiv = document.getElementById('result');
      const metaDiv = document.getElementById('meta');
      const imageWrap = document.getElementById('image-wrap');
      const fallbackText = document.getElementById('image-fallback');

      // Check for state parameter first
      const state = getStateParam();
      if (state) {
        const stateAbbr = state.toUpperCase();
        const info = stateInfo[stateAbbr];

        if (!info) {
          resultDiv.innerHTML = `No data found for state <span class="font-mono">${stateAbbr}</span>.`;
          metaDiv.textContent = 'State not in database';
          fallbackText.textContent = 'No match';
          return;
        }

        // Display state information
        resultDiv.innerHTML = `
          <div class="space-y-2">
            <h2 class="text-3xl font-bold text-indigo-400">${info.name}</h2>
            <p class="text-xl text-gray-300">${info.nickname}</p>
            <div class="space-y-1 text-sm mt-4">
              <p><strong>Capital:</strong> ${info.capital}</p>
              <p><strong>Population:</strong> ${info.population}</p>
              <p><strong>Area:</strong> ${info.area}</p>
              <p><strong>ZIP Prefix:</strong> ${info.zipPrefix}xxxx</p>
            </div>
          </div>`;
        metaDiv.textContent = `State: ${stateAbbr} ‚Ä¢ ${info.name}`;

        // Load state flag/image from Wikipedia
        const stateFlagUrl = `https://upload.wikimedia.org/wikipedia/commons/thumb/f/f7/Flag_of_${info.name.replace(' ', '_')}.svg/320px-Flag_of_${info.name.replace(' ', '_')}.svg.png`;
        try {
          const url = await loadImage(stateFlagUrl);
          const img = new Image();
          img.src = url;
          img.alt = `${info.name} Flag`;
          img.className = 'w-full h-48 object-contain bg-white fade-in';
          imageWrap.innerHTML = '';
          imageWrap.appendChild(img);
        } catch {
          // Fallback gradient with state abbreviation
          imageWrap.innerHTML = `<div class='w-full h-48 bg-gradient-to-br from-indigo-700 to-indigo-500 flex items-center justify-center text-white/90 text-6xl font-bold'>${stateAbbr}</div>`;
        }
        return;
      }

      const zip = getZipParam();
      if (!zip) {
        resultDiv.innerHTML = `Please provide a ZIP code or state in the URL.<br><span class="font-mono text-indigo-400">?zip=90210</span> or <span class="font-mono text-indigo-400">?state=TX</span>`;
        metaDiv.textContent = '';
        fallbackText.textContent = 'No ZIP or state provided';
        return;
      }

      // Handle DEFAULT case (nationwide delivery)
      if (zip === 'DEFAULT') {
        resultDiv.innerHTML = `
          <div class="space-y-1">
            <h2 class="text-2xl font-semibold text-indigo-400">Nationwide Delivery</h2>
            <p class="text-lg">Available across all US locations</p>
            <p class="text-sm text-gray-400 mt-2">No geo-specific targeting ‚Ä¢ Default fallback</p>
          </div>`;
        metaDiv.textContent = 'ZIP: DEFAULT ‚Ä¢ Nationwide coverage';

        // Load USA flag/map image
        const nationalImageUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Map_of_USA_with_state_names_2.svg/1200px-Map_of_USA_with_state_names_2.svg.png';
        try {
          const url = await loadImage(nationalImageUrl);
          const img = new Image();
          img.src = url;
          img.alt = 'United States Map';
          img.className = 'w-full h-48 object-cover fade-in';
          imageWrap.innerHTML = '';
          imageWrap.appendChild(img);
        } catch {
          imageWrap.innerHTML = `<div class='w-full h-48 bg-gradient-to-br from-indigo-700 to-indigo-500 flex items-center justify-center text-white/90 text-xl'>üá∫üá∏ USA</div>`;
        }
        return;
      }

      let data;
      try {
        data = await fetchCSV('data.csv');
      } catch (e) {
        resultDiv.textContent = 'Could not load ZIP code data';
        metaDiv.textContent = e.message || String(e);
        fallbackText.textContent = 'Data unavailable';
        return;
      }

      // Find ZIP in comprehensive database
      const match = data.find(r => r.zip === zip);
      if (!match) {
        resultDiv.innerHTML = `No data found for ZIP <span class="font-mono">${zip}</span>.`;
        metaDiv.textContent = 'ZIP code not in database';
        fallbackText.textContent = 'No match';
        return;
      }

      const city = match.primary_city || 'Unknown';
      const stateAbbr = match.state || '';
      const county = match.county || '';
      const zipType = match.type || 'STANDARD';
      const timezone = match.timezone ? match.timezone.replace('America/', '') : '';
      const acceptableCities = match.acceptable_cities || '';
      const population = match.irs_estimated_population || '0';

      // Build display content
      let typeLabel = zipType;
      if (zipType === 'UNIQUE') typeLabel = 'Unique (Organization-specific)';
      else if (zipType === 'PO BOX') typeLabel = 'PO Box Only';
      else if (zipType === 'MILITARY') typeLabel = 'Military';

      resultDiv.innerHTML = `
        <div class="space-y-2">
          <h2 class="text-2xl font-semibold text-indigo-400">${city}, ${stateAbbr}</h2>
          <div class="space-y-1 text-sm">
            <p><strong>County:</strong> ${county}</p>
            <p><strong>Type:</strong> ${typeLabel}</p>
            ${timezone ? `<p><strong>Timezone:</strong> ${timezone}</p>` : ''}
            ${acceptableCities ? `<p><strong>Also known as:</strong> ${acceptableCities}</p>` : ''}
            ${population !== '0' ? `<p><strong>Population:</strong> ${parseInt(population).toLocaleString()}</p>` : ''}
          </div>
        </div>`;
      metaDiv.textContent = `ZIP: ${zip} ‚Ä¢ ${city}, ${stateAbbr}`;

      // Try to load city image
      try {
        const stateFull = stateMap[stateAbbr] || stateAbbr;
        const url = await resolveImage(city, stateFull, stateAbbr);
        const img = new Image();
        img.src = url;
        img.alt = `${city}, ${stateAbbr}`;
        img.className = 'w-full h-48 object-cover fade-in';
        imageWrap.innerHTML = '';
        imageWrap.appendChild(img);
      } catch {
        // Fallback gradient with city name
        imageWrap.innerHTML = `<div class='w-full h-48 bg-gradient-to-br from-indigo-700 to-indigo-500 flex items-center justify-center text-white/90 text-xl font-semibold'>${city}, ${stateAbbr}</div>`;
      }
    }

    main();
  </script>
</body>
</html>
